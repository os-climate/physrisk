from importlib import import_module
import logging
from typing import Any, Optional, Protocol, cast

import pandas as pd
from physrisk.api.v1.common import Asset as APIAsset
from physrisk.kernel.assets import Asset

logger = logging.getLogger(__name__)


class AssetFactory(Protocol):
    def create_asset(self, api_assets: APIAsset) -> Asset: ...


default_oed_occ_codes_to_asset_types = {
    (1000, 1000): ("Asset", None),
    (1050, 1099): ("RealEstateAsset", "Buildings/Residential"),
    (1100, 1125): ("RealEstateAsset", "Buildings/Commercial"),
    (1150, 1159): ("ManufacturingAsset", None),  # Industrial
    (1200, 1231): ("RealEstateAsset", "Buildings/Commercial"),
    (1250, 1256): ("TransportationAsset", None),
    (1260, 1260): ("ManufacturingAsset", None),
    (1300, 1350): ("UtilitiesAsset", None),
    (1351, 1370): ("AgricultureAsset", None),
    (1400, 1412): ("TransportationAsset", None),  # Marine cargo
    # Industrial Facilities Models:
    (2000, 2352): ("ManufacturingAsset", None),  # Various manufacturing
    (2400, 2404): ("ManufacturingAsset", None),  # Mining
    (2450, 2470): ("OilAndGasAsset", None),
    (2500, 2500): ("PowerGeneratingAsset", "Hydro"),  # Power generation
    (2505, 2505): ("PowerGeneratingAsset", None),  # Geothermal
    (2510, 2510): (
        "ThermalPowerGeneratingAsset",
        "Gas",
    ),  # General category, assumed to include coal and gas
    (2515, 2515): ("ThermalPowerGeneratingAsset", None),  # Tidal
    (2520, 2520): ("ThermalPowerGeneratingAsset", "Nuclear"),
    (2521, 2521): ("ManufacturingAsset"),  # other nuclear facilities
    (2530, 2531): ("UtilitiesAsset"),  # Substations and transmission lines
    (2541, 2541): ("PowerGeneratingAsset", "Solar"),  # Wind power
    (2542, 2542): ("PowerGeneratingAsset", "Wind"),  # Wind power
    (2543, 2543): ("ThermalPowerGeneratingAsset", "Biomass"),  # Wind power
    (2520, 2521): ("ThermalPowerGeneratingAsset", "Nuclear"),  # Wind power
    (2550, 2550): ("UtilitiesAsset", None),  # Water treatment (potable)
    (2560, 2560): ("UtilitiesAsset", None),  # Waste management (waste)
    (2600, 2620): ("OilAndGasAsset", None),
    (2650, 2651): ("UtilitiesAsset", None),
    (2700, 2700): ("AgricultureAsset", None),
    (2750, 2780): ("TransportationAsset", None),
    # Offshore:
    (3000, 3031): ("OilAndGasAsset", None),
    (3032, 3033): ("PowerGeneratingAsset", "Wind"),  # Offshore facilities
    (3034, 3035): ("PowerGeneratingAsset", None),  # Offshore facilities
    (3036, 3036): ("PowerGeneratingAsset", "Solar"),  # Offshore facilities
}  # note intervals are closed on both ends


class DefaultAssetFactory(AssetFactory):
    """
    Mapping from Open Exposure Data (OED) codes to asset types for sectorial vulnerability models.
    """

    def __init__(
        self,
        occupancy_mapping: Optional[
            dict[tuple[int, int], tuple[str, Optional[str]]]
        ] = None,
    ):
        self.module = import_module("physrisk.kernel.assets")
        self.occupancy_mapping = (
            occupancy_mapping or default_oed_occ_codes_to_asset_types
        )
        interval_index = pd.IntervalIndex.from_tuples(
            data=self.occupancy_mapping.keys(), closed="both"
        )
        self.sectorial_repr = pd.DataFrame(
            {"mapping": list(self.occupancy_mapping.values())}, index=interval_index
        )

    def create_asset(self, api_asset: APIAsset) -> Asset:
        # Use oed_occ_codes_to_asset_types to map from occupancy_code to asset_class and type,
        kwargs = {}
        kwargs.update(api_asset.__dict__)
        if api_asset.model_extra is not None:
            kwargs.update(api_asset.model_extra)
        kwargs = {k: v for k, v in kwargs.items() if v is not None}
        # if occupancy code is provided, use this to determine asset class and type
        if api_asset.occupancy_code != 1000:
            match: tuple[str, Optional[str]] = self.sectorial_repr.loc[
                api_asset.occupancy_code
            ]["mapping"]
            asset_class, asset_type = match
            if match[1] is not None:
                kwargs["type"] = asset_type
            if api_asset.asset_class is None or api_asset.asset_class != "Asset":
                logger.warning(
                    "Both occupancy_code and asset_class provided; ignoring asset_class and using occupancy_code to determine class."
                )
        else:
            # otherwise, use asset_class and explicitly provided type.
            asset_class = (
                "Asset" if api_asset.asset_class is None else api_asset.asset_class
            )
            del kwargs["asset_class"]
        return self._create_asset(asset_class, kwargs)

    def _create_asset(self, asset_class: str, kwargs: dict[str, Any]) -> Asset:
        if hasattr(self.module, asset_class):
            init = getattr(self.module, asset_class)
            asset_obj = cast(
                Asset,
                init(**kwargs),
            )
            return asset_obj
        else:
            raise ValueError(f"asset type '{asset_class}' not found")
