from pathlib import Path
from typing import List, Optional
from physrisk.vulnerability_models.configuration.config_builders import (
    ConfigBuilderEberenzWind,
)
from physrisk.vulnerability_models.config_based_impact_curves import (
    VulnerabilityConfigItem,
)
from physrisk.vulnerability_models.configuration.config_builders import (
    ConfigBuilder,
    ConfigBuilderJRCFlood,
    vulnerability_config_dir,
    vulnerability_onboarding_dir,
)
from physrisk.vulnerability_models.config_based_impact_curves import (
    config_items_to_csv,
)
from physrisk.vulnerability_models.configuration.hazus_config_builders import (
    ConfigBuilderHazusFlood,
    ConfigBuilderHazusWind,
)


def build_all(source_dir: Optional[Path] = None):
    """Build all of the configuration.
    ConfigBuilderHazusFlood and ConfigBuilderHazusWind will be slow to run
    first time as these require downloading and processing large Hazus data files.
    Subsequent runs will be much faster as the processed files are cached.
    """
    config_items: list[VulnerabilityConfigItem] = []
    source_dir = vulnerability_onboarding_dir() if source_dir is None else source_dir
    config_builders: List[ConfigBuilder] = [
        ConfigBuilderJRCFlood(source_dir=source_dir),
        ConfigBuilderEberenzWind(source_dir=source_dir),
        ConfigBuilderHazusFlood(source_dir=source_dir),
        ConfigBuilderHazusWind(source_dir=source_dir),
    ]
    for builder in config_builders:
        builder.download_inputs()
        config_items += builder.build_config()
    config_items_to_csv(
        config_items, vulnerability_config_dir() / "candidate_vulnerability_config.csv"
    )
