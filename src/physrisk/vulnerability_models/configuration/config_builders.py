from pathlib import Path
from typing import List, Optional, Protocol
from fsspec import AbstractFileSystem
from fsspec.implementations.local import LocalFileSystem
import numpy as np
import pandas as pd

from physrisk.kernel.assets import Asset, PowerGeneratingAsset, RealEstateAsset
from physrisk.kernel.hazards import (
    CoastalInundation,
    PluvialInundation,
    RiverineInundation,
    Wind,
)
from physrisk.kernel.impact_distrib import ImpactType
from physrisk.vulnerability_models.config_based_impact_curves import (
    VulnerabilityConfigItem,
)


def vulnerability_onboarding_dir():
    """Path of the vulnerability on-boarding directory."""
    path = (
        Path(__file__).parents[4]
        / "docs"
        / "user_guide"
        / "vulnerability"
        / "vulnerability_functions"
    )
    return path


def vulnerability_config_dir():
    """Path of the vulnerability configuration directory."""
    path = Path(__file__).parents[2] / "data" / "static" / "vulnerability"
    return path


class ConfigBuilder(Protocol):
    def build_config(self) -> List[VulnerabilityConfigItem]: ...

    def download_inputs(self) -> None: ...


class ConfigBuilderBase:
    def __init__(
        self, source_dir: Optional[Path] = None, fs: Optional[AbstractFileSystem] = None
    ):
        """Instantiate base class for configuration builder.

        Args:
            source_dir (str): Full path to directory containing any source files.
                Defaults to None, in which case the default on-boarding directory in the
                repo is used.
            fs (Optional[AbstractFileSystem], optional): Instance of AbstractFileSystem to use to
                access source_dir e.g. S3FileSystem.
                Defaults to None, in which case a LocalFileSystem is assumed.
        """
        self.fs = fs if fs is not None else LocalFileSystem()
        self.source_dir = (
            source_dir if source_dir is not None else vulnerability_onboarding_dir()
        )


class ConfigBuilderJRCFlood(ConfigBuilderBase, ConfigBuilder):
    def build_config(self) -> List[VulnerabilityConfigItem]:
        """Create vulnerability config for flood based on the EU JRC global depth-damage functions.
        This replaces the notebook implementation and sets the pattern for code-based generation of the config.
        """

        # raw data is actually a reformatting of the original Excel spreadsheet to facilitate loading.
        raw_data = self.source_dir / "inundation_jrc" / "raw.csv"
        df = pd.read_csv(raw_data)

        # consistent with physrisk continent definition
        location_mappings = {
            "Europe": "Europe",
            "North America": "North America",
            "Central & South America": "South America",
            "Asia": "Asia",
            "Africa": "Africa",
            "Oceania": "Oceania",
            "Global": "Global",
        }
        type_mappings = {
            "Residential buildings": "Buildings/Residential",
            "Commercial buildings": "Buildings/Commercial",
            "Industrial buildings": "Buildings/Industrial",
        }

        config_items: List[VulnerabilityConfigItem] = []
        for mapping in type_mappings:
            type_df = df[df["Type"] == mapping]
            flood_depth = type_df["Flood depth [m]"].to_numpy()
            for location in location_mappings:
                # whether zero depth is considered really zero or a flood event with smallest depth
                zero_as_minimum = True if location == "North America" else False
                # for North America, the 0 depth damage is for flooding of any depth. We consider that a 1 cm inundation.
                depth = (
                    np.concatenate([[0, 0.01], flood_depth[1:]])
                    if zero_as_minimum
                    else flood_depth
                )

                mean = type_df[location + "_Mean"].to_numpy()
                std = type_df[location + "_Std"].to_numpy()
                mean = np.concatenate([[0], mean]) if zero_as_minimum else mean
                std = np.concatenate([[0], std]) if zero_as_minimum else std
                if np.any(np.isnan(mean)):
                    mean = []
                if np.any(np.isnan(std)):
                    std = []
                if not any(mean):
                    continue
                config_items.append(
                    VulnerabilityConfigItem(
                        hazard_class=",".join(
                            [
                                CoastalInundation.__name__,
                                PluvialInundation.__name__,
                                RiverineInundation.__name__,
                            ]
                        ),
                        asset_class=RealEstateAsset.__name__,
                        asset_identifier=f"type={type_mappings[mapping]},location={location_mappings[location]}",
                        indicator_id="flood_depth",
                        indicator_units="metres",
                        impact_id=str(ImpactType.damage.name),
                        curve_type="indicator/piecewise_linear",
                        points_x=depth.tolist(),
                        points_y=np.round(mean, 3).tolist(),
                        # points_z=std, # omit for now: until implemented
                    )
                )
        return config_items

    def download_inputs(self) -> None:
        pass


class ConfigBuilderEberenzWind(ConfigBuilderBase, ConfigBuilder):
    def build_config(self) -> List[VulnerabilityConfigItem]:
        """Create vulnerability config for generic wind assets based on
        Eberenz S, LÃ¼thi S, Bresch DN. Regional tropical cyclone impact functions
        for globally consistent risk assessments. Natural Hazards and Earth System Sciences.
        2021 Jan 29;21(1):393-415.
        """
        table_a2 = (
            self.source_dir / "wind_eberenz" / "Table_A2_Impact_Function_Slope.csv"
        )
        df = pd.read_csv(table_a2)
        v_half_lookup = (
            df[["region", "vhalf_b", "vhalf_c"]].set_index("region").to_dict()
        )
        v_half_north_america = (
            float(v_half_lookup["vhalf_b"]["NA2"])
            + float(v_half_lookup["vhalf_c"]["NA2"])
        ) / 2

        mapping = {
            "Asia": 74.7,
            "China Mainland": (
                float(v_half_lookup["vhalf_b"]["WP3"])
                + float(v_half_lookup["vhalf_c"]["WP3"])
            )
            / 2,
            "Europe": v_half_north_america,
            "Generic": v_half_north_america,
            "North America": v_half_north_america,
            "Oceania": (
                float(v_half_lookup["vhalf_b"]["OC"])
                + float(v_half_lookup["vhalf_c"]["OC"])
            )
            / 2,
            "South America": (
                float(v_half_lookup["vhalf_b"]["NA1"])
                + float(v_half_lookup["vhalf_c"]["NA1"])
            )
            / 2,
        }
        x = np.concat((np.arange(20.0, 55.0, 5.0), np.arange(60.0, 120.0, 10.0)))
        config_items: List[VulnerabilityConfigItem] = []
        for location, v_half in mapping.items():
            config_items.append(
                VulnerabilityConfigItem(
                    hazard_class=",".join([Wind.__name__]),
                    asset_class=Asset.__name__,
                    asset_identifier=f"type=Generic,location={location}",
                    indicator_id="max_speed",
                    indicator_units="m/s",
                    impact_id="damage",
                    curve_type="indicator/piecewise_linear",
                    points_x=x.tolist(),
                    points_y=np.round(self.vulnerability(x, v_half), 3).tolist(),
                )
            )
        return config_items

    def vulnerability(self, v, v_half):
        v_thresh = 25.7
        # v_half = 135.6 # wp4 74.7 135.6 190.5
        vn = np.where(v > v_thresh, v - v_thresh, 0) / (v_half - v_thresh)
        f = vn**3 / (1 + vn**3)
        return f

    def download_inputs(self) -> None:
        pass


class ConfigBuilderOffshoreWind(ConfigBuilderBase, ConfigBuilder):
    def build_config(self) -> List[VulnerabilityConfigItem]:
        """Generate configuration items for offshore wind vulnerability models.
        Simulating impacts of extreme events on grids with high penetrations of wind power resources
        https://docs.nrel.gov/docs/fy22osti/80639.pdf
        references
        Quantifying the hurricane risk to offshore wind turbines
        https://www.pnas.org/doi/pdf/10.1073/pnas.1111769109

        Returns:
            List[VulnerabilityConfigItem]: Configuration items for offshore wind vulnerability models.
        """
        # turbine pointed into the wind (active yawing)
        alpha, beta = 174, 19.3
        # turbine pointed perpendicular to the wind (no yawing)
        alpha, beta = 140, 18.6

        config_items: List[VulnerabilityConfigItem] = []

        x = np.concat((np.arange(20.0, 55.0, 5.0), np.arange(60.0, 120.0, 10.0)))
        # Placeholder example curve
        for label, alpha, beta in [("ActiveYaw", 174, 19.3), ("NoYaw", 140, 18.6)]:
            config_items.append(
                VulnerabilityConfigItem(
                    hazard_class=",".join([Wind.__name__]),
                    asset_class=Asset.__name__,
                    asset_identifier=f"type=WindTurbine/{label}",
                    indicator_id="max_speed",
                    indicator_units="m/s",
                    impact_id="damage",
                    curve_type="indicator/piecewise_linear",
                    points_x=x.tolist(),
                    points_y=np.round(self.vulnerability(x, alpha, beta), 3).tolist(),
                )
            )
        return config_items

    def vulnerability(self, v: float, alpha: float, beta: float) -> float:
        vn = v / alpha
        f = vn**beta / (1 + vn**beta)
        return f


class SectorialModelsConfigBuilder(ConfigBuilder):
    def build_config(self) -> List[VulnerabilityConfigItem]:
        """Generate configuration items for sectorial vulnerability models.

        Returns:
            List[VulnerabilityConfigItem]: Configuration items for sectorial vulnerability models.
        """

        # https://africa.wri.org/sites/default/files/20# 21-11/assessing-physical-risks-european-bank.pdf
        generic_drought_item = VulnerabilityConfigItem(
            hazard_class="Drought",
            asset_class="ManufacturingAsset",
            asset_identifier="type=Generic",
            indicator_id="months/spei12m/below/threshold",
            indicator_units="index",
            impact_id="disruption",
            curve_type="threshold/piecewise_linear",
            points_x=np.array([-2, -2.5, -3, -3.5]),
            points_y=np.array([[0, 0.1, 0.2, 1.0]]),
        )

        # # https://www.ilo.org/sites/default/files/wcmsp5/groups/public/%40dgreports/%40dcomm/%40publ/documents/publication/wcms_711919.pdf
        generic_productivity_loss_item = VulnerabilityConfigItem(
            hazard_class="ChronicHeat",
            asset_class="ManufacturingAsset",
            asset_identifier="type=Generic",
            indicator_id="days_wbgt_above",
            indicator_units="days/year",
            impact_id="disruption",
            curve_type="threshold/piecewise_linear",
            points_x=np.array([20, 24, 28, 32, 36, 40, 44, 48]),
            points_y=np.array([[0, 0.01, 0.125, 0.45, 0.775, 0.975, 1.0, 1.0]]),
        )

        config_items: List[VulnerabilityConfigItem] = [
            generic_drought_item,
            generic_productivity_loss_item,
        ]

        # https://nhess.copernicus.org/articles/24/847/2024/
        damage_large_hail_day = {
            (PowerGeneratingAsset, "Solar"): 0.3,
            (Asset, None): 0.1 / 100.0,
        }

        potential_hail_day_to_hail_day = 50.0
        # pending more complete documentation, the conversion factor is estimated as follows:
        # 82,300 building claims over 20 years with MESHS > 50 mm out of 212,026 claims (over 4 Swiss cantons)
        # 82,300 / 20 = 4,115 claims per year
        # estimated 989,000 insurable buildings in these cantons
        # 4,115 / 989,000 = 0.00416 potential hail days per year
        # mean climatic hail indicator across Switzerland is approx 0.23 days/year
        # 0.23 / 0.00416 = approx 50 conversion factor from potential hail day to hail day

        for key, damage_1d in damage_large_hail_day.items():
            config_items.append(
                VulnerabilityConfigItem(
                    hazard_class="Hail",
                    asset_class=key[0].__name__,
                    asset_identifier=f"type={key[1]},location=Generic"
                    if key[1]
                    else "type=Generic,location=Global",
                    indicator_id="days/above/5cm",
                    indicator_units="days/year",
                    impact_id="damage",
                    impact_units=None,
                    curve_type="indicator/piecewise_linear",
                    points_x=np.array([0.0, 10.0]),
                    points_y=np.round(
                        np.array(
                            [0.0, damage_1d * 10.0 * potential_hail_day_to_hail_day]
                        ),
                        6,
                    ),
                )
            )

        return config_items
