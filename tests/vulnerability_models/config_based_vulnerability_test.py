import pathlib
from typing import cast

import numpy as np
import pandas as pd
import pytest
from physrisk import requests
from physrisk.api.v1.common import Assets
from physrisk.data.inventory import EmbeddedInventory
from physrisk.data.pregenerated_hazard_model import ZarrHazardModel
from physrisk.data.zarr_reader import ZarrReader
from physrisk.hazard_models.core_hazards import get_default_source_paths
from physrisk.kernel.assets import (
    Asset,
    ManufacturingAsset,
    PowerGeneratingAsset,
    RealEstateAsset,
    ThermalPowerGeneratingAsset,
)
from physrisk.vulnerability_models.config_based_model import (
    ConfigBasedVulnerabilityModelAcute,
    ImpactCurveKey,
    PiecewiseLinearImpactCurve,
    config_items_from_csv,
    config_items_to_csv,
)
from physrisk.vulnerability_models.vulnerability import (
    VulnerabilityConfigItem,
    VulnerabilityModelsFactory,
)
from tests.data.hazard_model_store_test import (
    add_curves,
    shape_transform_21600_43200,
    zarr_memory_store,
)


def basic_vulnerability_config():
    return [
        VulnerabilityConfigItem(
            hazard_class="Wind",
            asset_class="Asset",
            asset_identifier="type=Generic,location=Europe",
            indicator_id="max_speed",
            indicator_units="m/s",
            impact_id="damage",
            impact_units="",
            curve_type="indicator/piecewise_linear",
            points_x=[20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 130],
            points_y=[
                0,
                0,
                0,
                0.0025,
                0.01,
                0.02,
                0.04,
                0.08,
                0.12,
                0.17,
                0.23,
                0.29,
                0.35,
                0.42,
                0.48,
                1.0,
            ],
            activation_of_points_x=40,
            cap_of_points_x=None,
            cap_of_points_y=1,
        ),
        VulnerabilityConfigItem(
            hazard_class="Wind",
            asset_class="Asset",
            asset_identifier="type=Generic,location=Asia",
            indicator_id="max_speed",
            indicator_units="m/s",
            impact_id="damage",
            impact_units="",
            curve_type="indicator/piecewise_linear",
            points_x=[20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 130],
            points_y=[
                0,
                0,
                0,
                0.01,
                0.04,
                0.09,
                0.17,
                0.25,
                0.34,
                0.42,
                0.49,
                0.55,
                0.61,
                0.66,
                0.71,
                1.0,
            ],
            activation_of_points_x=40,
            cap_of_points_x=None,
            cap_of_points_y=1,
        ),
    ]


def config_based_vulnerability_models():
    return [
        VulnerabilityConfigItem(
            hazard_class="Fire",
            asset_class="RealEstateAsset",
            asset_identifier="type=Generic,location=Generic",
            indicator_id="fire_probability",
            indicator_units="",
            impact_id="damage",
            impact_units="",
            curve_type="threshold/piecewise_linear",
            points_x=[0],
            points_y=[0.74],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=1,
        ),
        VulnerabilityConfigItem(
            hazard_class="Wind",
            asset_class="RealEstateAsset",
            asset_identifier="type=Generic,location=Generic",
            indicator_id="max_speed",
            indicator_units="m/s",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 130],
            points_y=[
                0,
                0,
                0,
                0.0025,
                0.01,
                0.02,
                0.04,
                0.08,
                0.12,
                0.17,
                0.23,
                0.29,
                0.35,
                0.42,
                0.48,
                1.0,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="Wind",
            asset_class="RealEstateAsset",
            asset_identifier="type=Generic,location=Europe",
            indicator_id="max_speed",
            indicator_units="m/s",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 130],
            points_y=[
                0,
                0,
                0,
                0.0025,
                0.01,
                0.02,
                0.04,
                0.08,
                0.12,
                0.17,
                0.23,
                0.29,
                0.35,
                0.42,
                0.48,
                1.0,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="Wind",
            asset_class="RealEstateAsset",
            asset_identifier="type=Generic,location=North America",
            indicator_id="max_speed",
            indicator_units="m/s",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 120],
            points_y=[
                0,
                0,
                0,
                0.01,
                0.07,
                0.15,
                0.26,
                0.39,
                0.5,
                0.6,
                0.68,
                0.75,
                0.8,
                0.83,
                0.87,
                1.0,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="Wind",
            asset_class="RealEstateAsset",
            asset_identifier="type=Generic,location=South America",
            indicator_id="max_speed",
            indicator_units="m/s",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 130],
            points_y=[
                0,
                0,
                0,
                0.0025,
                0.01,
                0.02,
                0.04,
                0.08,
                0.12,
                0.17,
                0.23,
                0.29,
                0.35,
                0.42,
                0.48,
                1.0,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="Wind",
            asset_class="RealEstateAsset",
            asset_identifier="type=Generic,location=Asia",
            indicator_id="max_speed",
            indicator_units="m/s",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 130],
            points_y=[
                0,
                0,
                0,
                0.01,
                0.04,
                0.09,
                0.17,
                0.25,
                0.34,
                0.42,
                0.49,
                0.55,
                0.61,
                0.66,
                0.71,
                1.0,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="Wind",
            asset_class="RealEstateAsset",
            asset_identifier="type=Generic,location=Oceania",
            indicator_id="max_speed",
            indicator_units="m/s",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 110],
            points_y=[
                0,
                0,
                0,
                0.03,
                0.11,
                0.23,
                0.37,
                0.52,
                0.63,
                0.71,
                0.78,
                0.83,
                0.87,
                0.89,
                0.92,
                1.0,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="Hail",
            asset_class="PowerGeneratingAsset",
            asset_identifier="type=Wind,location=Generic",
            indicator_id="days/above/5cm",
            indicator_units="days/year",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0, 6],
            points_y=[0, 0.2],
            activation_of_points_x=None,
            cap_of_points_x=6,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="Hail",
            asset_class="PowerGeneratingAsset",
            asset_identifier="type=Solar,location=Generic",
            indicator_id="days/above/5cm",
            indicator_units="days/year",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0, 6],
            points_y=[0, 1.0],
            activation_of_points_x=None,
            cap_of_points_x=6,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="Hail",
            asset_class="PowerGeneratingAsset",
            asset_identifier="type=Generic,location=Generic",
            indicator_id="days/above/5cm",
            indicator_units="days/year",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0, 6],
            points_y=[0, 0.034],
            activation_of_points_x=None,
            cap_of_points_x=6,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="Hail",
            asset_class="RealEstateAsset",
            asset_identifier="type=Generic,location=Generic",
            indicator_id="days/above/5cm",
            indicator_units="days/year",
            impact_id="damage",
            impact_units="",
            curve_type="indicator/piecewise_linear",
            points_x=[0, 6],
            points_y=[0, 0.139],
            activation_of_points_x=None,
            cap_of_points_x=6,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="Hail",
            asset_class="ManufacturingAsset",
            asset_identifier="type=Generic,location=Generic",
            indicator_id="days/above/5cm",
            indicator_units="days/year",
            impact_id="damage",
            impact_units="",
            curve_type="indicator/piecewise_linear",
            points_x=[0, 6],
            points_y=[0, 0.074],
            activation_of_points_x=None,
            cap_of_points_x=6,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation,",
            asset_class="RealEstateAsset",
            asset_identifier="type=Buildings/Residential,location=Europe",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
            points_y=[0, 0.25, 0.4, 0.5, 0.6, 0.75, 0.85, 0.95, 1],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
            asset_class="RealEstateAsset",
            asset_identifier="type=Buildings/Residential,location=North America",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
            points_y=[
                0.20,
                0.44,
                0.58,
                0.68,
                0.78,
                0.85,
                0.924,
                0.959,
                1,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
            asset_class="RealEstateAsset",
            asset_identifier="type=Buildings/Residential,location=South America",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
            points_y=[
                0,
                0.49,
                0.71,
                0.84,
                0.949,
                0.984,
                1,
                1,
                1,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
            asset_class="RealEstateAsset",
            asset_identifier="type=Buildings/Residential,location=Asia",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
            points_y=[
                0,
                0.33,
                0.49,
                0.62,
                0.72,
                0.87,
                0.93,
                0.98,
                1,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
            asset_class="RealEstateAsset",
            asset_identifier="type=Buildings/Residential,location=Africa",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
            points_y=[
                0,
                0.22,
                0.38,
                0.53,
                0.64,
                0.82,
                0.90,
                0.957,
                1,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
            asset_class="RealEstateAsset",
            asset_identifier="type=Buildings/Residential,location=Oceania",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
            points_y=[
                0,
                0.48,
                0.64,
                0.71,
                0.79,
                0.93,
                0.967,
                0.983,
                1,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
            asset_class="RealEstateAsset",
            asset_identifier="type=Buildings/Commercial,location=Europe",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
            points_y=[0, 0.15, 0.3, 0.45, 0.55, 0.75, 0.9, 1, 1],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
            asset_class="RealEstateAsset",
            asset_identifier="type=Buildings/Commercial,location=North America",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
            points_y=[
                0.018,
                0.24,
                0.376,
                0.47,
                0.55,
                0.69,
                0.82,
                0.908,
                1,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
            asset_class="RealEstateAsset",
            asset_identifier="type=Buildings/Commercial,location=South America",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
            points_y=[
                0,
                0.61,
                0.84,
                0.92,
                0.992,
                1,
                1,
                1,
                1,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
            asset_class="RealEstateAsset",
            asset_identifier="type=Buildings/Commercial,location=Asia",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
            points_y=[
                0,
                0.38,
                0.54,
                0.66,
                0.76,
                0.88,
                0.94,
                0.981,
                1,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
            asset_class="RealEstateAsset",
            asset_identifier="type=Buildings/Commercial,location=Oceania",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
            points_y=[
                0,
                0.24,
                0.48,
                0.67,
                0.86,
                1,
                1,
                1,
                1,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
            asset_class="RealEstateAsset",
            asset_identifier="type=Buildings/Commercial,location=Generic",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
            points_y=[
                0,
                0.32,
                0.51,
                0.63,
                0.74,
                0.86,
                0.93,
                0.978,
                1,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
            asset_class="Asset",
            asset_identifier="type=Generic,location=Europe",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
            points_y=[0, 0.15, 0.27, 0.4, 0.52, 0.7, 0.85, 1, 1],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
            asset_class="Asset",
            asset_identifier="type=Generic,location=North America",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
            points_y=[
                0.026,
                0.32,
                0.51,
                0.64,
                0.74,
                0.86,
                0.94,
                0.98,
                1,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
            asset_class="Asset",
            asset_identifier="type=Generic,location=South America",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
            points_y=[
                0,
                0.667,
                0.89,
                0.947,
                1,
                1,
                1,
                1,
                1,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
            asset_class="Asset",
            asset_identifier="type=Generic,location=Asia",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
            points_y=[
                0,
                0.28,
                0.48,
                0.63,
                0.72,
                0.86,
                0.91,
                0.955,
                1,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
            asset_class="Asset",
            asset_identifier="type=Generic,location=Africa",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
            points_y=[
                0,
                0.063,
                0.25,
                0.403,
                0.49,
                0.68,
                0.919,
                1,
                1,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
            asset_class="Asset",
            asset_identifier="type=Generic,location=Generic",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
            points_y=[
                0,
                0.30,
                0.48,
                0.60,
                0.69,
                0.82,
                0.92,
                0.987,
                1,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="Drought",
            asset_class="Asset",
            asset_identifier="type=Buildings/Commercial,location=Generic",
            indicator_id="months/spei3m/below/-2",
            indicator_units="months/year",
            impact_id="damage",
            impact_units="",
            curve_type="indicator/piecewise_linear",
            points_x=[0, 0.5, 3],
            points_y=[0, 0, 0.01],
            activation_of_points_x=0.5,
            cap_of_points_x=3,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="Drought",
            asset_class="ThermalPowerGeneratingAsset",
            asset_identifier="type=Generic,location=Generic",
            indicator_id="months/spei3m/below/-2",
            indicator_units="months/year",
            impact_id="disruption",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0, 12],
            points_y=[0, 0.2],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="Drought",
            asset_class="ManufacturingAsset",
            asset_identifier="type=Chemical,location=Generic",
            indicator_id="months/spei3m/below/-2",
            indicator_units="months/year",
            impact_id="disruption",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[0, 12],
            points_y=[0, 0.3],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="ChronicHeat",
            asset_class="PowerGeneratingAsset",
            asset_identifier="type=Solar,location=Generic",
            indicator_id="days_tas/above/{temp_c}c",
            indicator_units="days/year",
            impact_id="disruption",
            impact_units=None,
            curve_type="threshold/piecewise_linear",
            points_x=[0, 3, 103],
            points_y=[0, 0, 0.37],
            activation_of_points_x=3,
            cap_of_points_x=None,
            cap_of_points_y=1.0,
        ),
        VulnerabilityConfigItem(
            hazard_class="ChronicHeat",
            asset_class="ManufacturingAsset",
            asset_identifier="type=Chemical,location=Generic",
            indicator_id="days_tas/above/{temp_c}c",
            indicator_units="days/year",
            impact_id="disruption",
            impact_units=None,
            curve_type="threshold/piecewise_linear",
            points_x=[15, 25, 35, 45, 55, 65],
            points_y=[0, 0.1, 0.25, 0.5, 0.8, 1.0],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="ChronicHeat",
            asset_class="ManufacturingAsset",
            asset_identifier="type=Chemical,location=Generic",
            indicator_id="days_wbgt_above",
            indicator_units="days/year",
            impact_id="disruption",
            impact_units=None,
            curve_type="threshold/piecewise_linear",
            points_x=[0, 32, 35],
            points_y=[0, 0.5, 0.75],
            activation_of_points_x=32,
            cap_of_points_x=35,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="ChronicHeat",
            asset_class="ThermalPowerGeneratingAsset",
            asset_identifier="type=Generic,location=Generic",
            indicator_id="days_wbgt_above",
            indicator_units="days/year",
            impact_id="disruption",
            impact_units=None,
            curve_type="threshold/piecewise_linear",
            points_x=[0, 32, 35],
            points_y=[0, 0.5, 0.75],
            activation_of_points_x=32,
            cap_of_points_x=35,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
            asset_class="Asset",
            asset_identifier="hazus_fl_building_dmg_id=1035",
            indicator_id="flood_depth",
            indicator_units="metres",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[
                -1.2192,
                -0.9144,
                -0.6096,
                -0.3048,
                0,
                0.3048,
                0.6096,
                0.9144,
                1.2192,
                1.524,
                1.8288,
                2.1336,
                2.4384,
                2.7432,
                3.048,
                3.3528,
                3.6576,
                3.9624,
                4.2672,
                4.572,
                4.8768,
                5.1816,
                5.4864,
                5.7912,
                6.096,
                6.4008,
                6.7056,
                7.0104,
                7.3152,
            ],
            points_y=[
                0,
                0,
                0,
                0,
                0.01,
                0.02,
                0.05,
                0.15,
                0.3,
                0.4,
                0.4,
                0.4,
                0.4,
                0.4,
                0.4,
                0.4,
                0.4,
                0.4,
                0.4,
                0.4,
                0.4,
                0.4,
                0.4,
                0.4,
                0.4,
                0.4,
                0.4,
                0.4,
                0.4,
            ],
            activation_of_points_x=0,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
        VulnerabilityConfigItem(
            hazard_class="Wind",
            asset_class="Asset",
            asset_identifier="hazus_ws_building_dmg_id=1035",
            indicator_id="max_speed",
            indicator_units="m/s",
            impact_id="damage",
            impact_units=None,
            curve_type="indicator/piecewise_linear",
            points_x=[
                22.35,
                24.59,
                26.82,
                29.06,
                31.29,
                33.53,
                35.76,
                38.00,
                40.23,
                42.47,
                44.70,
                46.94,
                49.18,
                51.41,
                53.64,
                55.88,
                58.11,
                60.35,
                62.59,
                64.82,
                67.06,
                69.29,
                71.53,
                73.76,
                76.00,
                78.23,
                80.47,
                82.70,
                84.94,
                87.17,
                89.41,
                91.64,
                93.88,
                96.11,
                98.35,
                100.58,
                102.82,
                105.06,
                107.29,
                109.53,
                111.76,
            ],
            points_y=[
                0,
                0,
                0.00034,
                0.00068,
                0.00131,
                0.0024,
                0.00422,
                0.00697,
                0.01091,
                0.01623,
                0.02302,
                0.03255,
                0.04449,
                0.06182,
                0.08373,
                0.11759,
                0.15836,
                0.20806,
                0.26597,
                0.3268,
                0.39282,
                0.46269,
                0.53287,
                0.5896,
                0.6463,
                0.70293,
                0.75299,
                0.78164,
                0.82841,
                0.86405,
                0.89275,
                0.90493,
                0.92122,
                0.93966,
                0.95623,
                0.96491,
                0.97141,
                0.977,
                0.98491,
                0.98868,
                0.98868,
            ],
            activation_of_points_x=None,
            cap_of_points_x=None,
            cap_of_points_y=None,
        ),
    ]


def test_create_vulnerability_model():
    factory = VulnerabilityModelsFactory(config=basic_vulnerability_config())
    vulnerability_models = factory.vulnerability_models()
    generic_model = vulnerability_models.vuln_model_for_asset_of_type(Asset)[0]
    assert isinstance(generic_model, ConfigBasedVulnerabilityModelAcute)
    asset = Asset(location="Europe", latitude=0, longitude=0)
    damage_curve = generic_model.curves[
        ImpactCurveKey.get(asset, generic_model.asset_attributes)
    ]
    assert isinstance(damage_curve, PiecewiseLinearImpactCurve)
    expected_item = next(
        v
        for v in basic_vulnerability_config()
        if v.asset_identifier == "type=Generic,location=Europe"
    )
    np.testing.assert_array_almost_equal(
        cast(PiecewiseLinearImpactCurve, damage_curve).points_y, expected_item.points_y
    )


@pytest.mark.skip("example, not test")
def test_read_write_utilities(working_dir):
    config = basic_vulnerability_config()
    path = str(pathlib.Path(working_dir, "test_config.csv"))
    config_items_to_csv(config, path)
    items = config_items_from_csv(path)
    assert items is not None


def test_config_based_vulnerability_models(working_dir):
    location = "North America"
    latitudes = np.array([32.6017])
    longitudes = np.array([-87.7811])

    assets = [
        RealEstateAsset(
            location=location,
            latitude=latitudes[0],
            longitude=longitudes[0],
            type="Buildings/Commercial",
        ),
        PowerGeneratingAsset(
            location=location,
            latitude=latitudes[0],
            longitude=longitudes[0],
            type="Solar",
        ),
        ThermalPowerGeneratingAsset(
            location=location,
            latitude=latitudes[0],
            longitude=longitudes[0],
            type=None,
        ),
        ManufacturingAsset(
            location=location,
            latitude=latitudes[0],
            longitude=longitudes[0],
            type="Chemical",
        ),
        Asset(
            location=location,
            latitude=latitudes[0],
            longitude=longitudes[0],
            type=None,
        ),
        Asset(
            location=location,
            latitude=latitudes[0],
            longitude=longitudes[0],
            type=None,
            hazus_fl_building_dmg_id=1035,
            hazus_ws_building_dmg_id=1035,
        ),
        RealEstateAsset(
            location=location,
            latitude=latitudes[0],
            longitude=longitudes[0],
            type=None,
        ),
    ]

    assets[-1].hazus_fl_building_dmg_id = 1035
    assets[-1].hazus_ws_building_dmg_id = 1035

    request = requests.AssetImpactRequest(
        assets=Assets(items=[]),
        include_asset_level=True,
        include_calc_details=True,
        years=[2050],
        scenarios=["ssp585"],
    )

    path = str(pathlib.Path(working_dir, "test_vulnerability_config.csv"))
    config_items = config_based_vulnerability_models()
    config_items_to_csv(config_items, path)
    config_items = config_items_from_csv(path)
    factory = VulnerabilityModelsFactory(config=config_items)
    vulnerability_models = factory.vulnerability_models(disable_api_calls=True)

    store, root = zarr_memory_store()

    return_periods = [2.0, 5.0, 10.0, 25.0, 50.0, 100.0, 250.0, 500.0, 1000.0]
    shape, t = shape_transform_21600_43200(return_periods=return_periods)
    add_curves(
        root,
        longitudes,
        latitudes,
        "inundation/wri/v2/inunriver_rcp8p5_MIROC-ESM-CHEM_2050",
        shape,
        np.array(
            [
                0.0012,
                0.39,
                0.85,
                1.39,
                1.75,
                2.09,
                2.51,
                2.82,
                3.12,
            ]
        ),
        return_periods,
        t,
    )
    add_curves(
        root,
        longitudes,
        latitudes,
        "inundation/wri/v2/inuncoast_rcp8p5_wtsub_2050_0",
        shape,
        np.array(
            [
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ]
        ),
        return_periods,
        t,
    )

    return_periods = [
        20,
        30,
        40,
        50,
        60,
        70,
        80,
        90,
        100,
        200,
        300,
        400,
        500,
        600,
        700,
        800,
        900,
        1000,
    ]
    shape, t = shape_transform_21600_43200(return_periods=return_periods)
    add_curves(
        root,
        longitudes,
        latitudes,
        "wind/iris/v1/max_speed_ssp585_2050",
        shape,
        np.array(
            [
                24.44,
                26.79,
                28.63,
                30.10,
                31.03,
                32.00,
                33.04,
                33.75,
                34.23,
                39.33,
                43.0,
                44.96,
                46.19,
                47.62,
                48.58,
                48.83,
                49.79,
                50.11,
            ]
        ),
        return_periods,
        t,
    )

    return_periods = [5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60]
    shape, t = shape_transform_21600_43200(return_periods=return_periods)
    add_curves(
        root,
        longitudes,
        latitudes,
        "chronic_heat/osc/v2/days_wbgt_above_ACCESS-CM2_ssp585_2050",
        shape,
        np.array(
            [
                363.65,
                350.21,
                303.64,
                240.48,
                181.83,
                128.47,
                74.40,
                1.40,
                0.0,
                0.0,
                0.0,
                0.0,
            ]
        ),
        return_periods,
        t,
    )

    return_periods = [0.0]
    shape, t = shape_transform_21600_43200(return_periods=return_periods)
    add_curves(
        root,
        longitudes,
        latitudes,
        "fire/jupiter/v1/fire_probability_ssp585_2050",
        shape,
        np.array([0.31867]),
        return_periods,
        t,
    )
    add_curves(
        root,
        longitudes,
        latitudes,
        "drought/jupiter/v1/months_spei3m_below_-2_ssp585_2050",
        shape,
        np.array([0.17918]),
        return_periods,
        t,
    )
    add_curves(
        root,
        longitudes,
        latitudes,
        "hail/jupiter/v1/days_above_5cm_ssp585_2050",
        shape,
        np.array([0.67936]),
        return_periods,
        t,
    )
    add_curves(
        root,
        longitudes,
        latitudes,
        "chronic_heat/osc/v2/days_tas_above_25c_ACCESS-CM2_ssp585_2050",
        shape,
        np.array([148.6]),
        return_periods,
        t,
    )
    add_curves(
        root,
        longitudes,
        latitudes,
        "chronic_heat/osc/v2/days_tas_above_30c_ACCESS-CM2_ssp585_2050",
        shape,
        np.array([65.31]),
        return_periods,
        t,
    )
    add_curves(
        root,
        longitudes,
        latitudes,
        "chronic_heat/osc/v2/days_tas_above_35c_ACCESS-CM2_ssp585_2050",
        shape,
        np.array([0.6]),
        return_periods,
        t,
    )
    add_curves(
        root,
        longitudes,
        latitudes,
        "chronic_heat/osc/v2/days_tas_above_40c_ACCESS-CM2_ssp585_2050",
        shape,
        np.array([0.0]),
        return_periods,
        t,
    )
    add_curves(
        root,
        longitudes,
        latitudes,
        "chronic_heat/osc/v2/days_tas_above_45c_ACCESS-CM2_ssp585_2050",
        shape,
        np.array([0.0]),
        return_periods,
        t,
    )
    add_curves(
        root,
        longitudes,
        latitudes,
        "chronic_heat/osc/v2/days_tas_above_50c_ACCESS-CM2_ssp585_2050",
        shape,
        np.array([0.0]),
        return_periods,
        t,
    )
    add_curves(
        root,
        longitudes,
        latitudes,
        "chronic_heat/osc/v2/days_tas_above_55c_ACCESS-CM2_ssp585_2050",
        shape,
        np.array([0.0]),
        return_periods,
        t,
    )

    source_paths = get_default_source_paths(EmbeddedInventory())

    response = requests._get_asset_impacts(
        request,
        ZarrHazardModel(source_paths=source_paths, reader=ZarrReader(store)),
        vulnerability_models=vulnerability_models,
        assets=assets,
    )

    impacts = {
        impact.hazard_type: impact.impact_mean
        for impact in response.asset_impacts[0].impacts
    }
    np.testing.assert_almost_equal(impacts["Fire"], 0.2358158 / 500.0)
    np.testing.assert_almost_equal(impacts["Wind"], 0.001040497)
    np.testing.assert_almost_equal(impacts["Hail"], 0.015738506)
    np.testing.assert_almost_equal(impacts["CoastalInundation"], 0.009)
    np.testing.assert_almost_equal(impacts["RiverineInundation"], 0.101327466)
    np.testing.assert_almost_equal(impacts["Drought"], 0.0)

    impacts = {
        impact.hazard_type: impact.impact_mean
        for impact in response.asset_impacts[1].impacts
    }
    np.testing.assert_almost_equal(impacts["Hail"], 0.1132266621)
    np.testing.assert_almost_equal(impacts["ChronicHeat"], 0.040246371)
    np.testing.assert_almost_equal(impacts["CoastalInundation"], 0.013)
    np.testing.assert_almost_equal(impacts["RiverineInundation"], 0.136345865)

    impacts = {
        impact.hazard_type: impact.impact_mean
        for impact in response.asset_impacts[2].impacts
    }
    np.testing.assert_almost_equal(impacts["ChronicHeat"], 0.208428085)
    np.testing.assert_almost_equal(impacts["Drought"], 0.002986333271)
    np.testing.assert_almost_equal(impacts["Hail"], 0.003849706511)
    np.testing.assert_almost_equal(impacts["CoastalInundation"], 0.013)
    np.testing.assert_almost_equal(impacts["RiverineInundation"], 0.136345865)

    impacts = {
        impact.hazard_type: impact.impact_mean
        for impact in response.asset_impacts[3].impacts
    }
    np.testing.assert_almost_equal(impacts["Hail"], 0.008378772994)
    np.testing.assert_almost_equal(impacts["Drought"], 0.004479499906)
    np.testing.assert_almost_equal(impacts["ChronicHeat"], 0.067715752259)
    np.testing.assert_almost_equal(impacts["CoastalInundation"], 0.013)
    np.testing.assert_almost_equal(impacts["RiverineInundation"], 0.136345865)

    impacts = {
        impact.hazard_type: impact.impact_mean
        for impact in response.asset_impacts[4].impacts
    }
    np.testing.assert_almost_equal(impacts["CoastalInundation"], 0.013)
    np.testing.assert_almost_equal(impacts["RiverineInundation"], 0.136345865)

    impacts = {
        impact.hazard_type: impact.impact_mean
        for impact in response.asset_impacts[5].impacts
    }
    np.testing.assert_almost_equal(impacts["Wind"], 0.000203201159)
    np.testing.assert_almost_equal(impacts["CoastalInundation"], 0.0)
    np.testing.assert_almost_equal(impacts["RiverineInundation"], 0.043734252)

    impacts = {
        impact.hazard_type: impact.impact_mean
        for impact in response.asset_impacts[6].impacts
    }
    np.testing.assert_almost_equal(impacts["Fire"], 0.235815804 / 500.0)
    np.testing.assert_almost_equal(impacts["Wind"], 0.000203201159)
    np.testing.assert_almost_equal(impacts["Hail"], 0.015738506029)
    np.testing.assert_almost_equal(impacts["CoastalInundation"], 0.0)
    np.testing.assert_almost_equal(impacts["RiverineInundation"], 0.043734252)


@pytest.mark.skip("Only to be run when importing HAZUS damage functions.")
def test_import_hazus_damage_function(working_dir):
    tab = "FL_BuildingDamageFns"
    input_path = pathlib.Path(
        working_dir,
        "<Hazus target>.xlsx",
    )
    df = pd.read_excel(io=str(input_path), sheet_name=tab)
    if "damageFnId" not in df.columns:
        raise ValueError(f"{tab} does not contain any 'damageFnId' column")
    attribute = "hazus_" + tab.replace("DamageFns", "_dmg_id").lower()
    impact_id = "disruption" if "_downtime_" in attribute else "damage"
    if tab.split("_")[0].upper() == "FL":
        hazard_class = "CoastalInundation,PluvialInundation,RiverineInundation"
        indicator_id = "flood_depth"
        indicator_units = "metres"
        if np.all(
            [column.endswith("m") for column in df.columns if column.startswith("dmg_")]
        ):
            points_x = [
                float(column[4:-1])
                for column in df.columns
                if column.startswith("dmg_")
            ]
        else:
            raise ValueError(f"Unsupported indicator units for {tab}")
    elif tab.split("_")[0].upper() == "WS":
        hazard_class = "Wind"
        indicator_id = "max_speed"
        indicator_units = "m/s"
        if np.all(
            [
                column.endswith("kmh")
                for column in df.columns
                if column.startswith("dmg_")
            ]
        ):
            points_x = [
                float(column[4:-3]) / 3.6
                for column in df.columns
                if column.startswith("dmg_")
            ]
        elif np.all(
            [
                column.endswith("ms")
                for column in df.columns
                if column.startswith("dmg_")
            ]
        ):
            points_x = [
                float(column[4:-2])
                for column in df.columns
                if column.startswith("dmg_")
            ]
        else:
            raise ValueError(f"Unsupported indicator units for {tab}")
    else:
        raise ValueError(f"Unsupported hazard class for {tab}")
    config_items = list(
        df.apply(
            lambda row: VulnerabilityConfigItem(
                hazard_class=hazard_class,
                asset_class="Asset",
                asset_identifier=attribute + "=" + str(row["damageFnId"]),
                indicator_id=indicator_id,
                indicator_units=indicator_units,
                impact_id=impact_id,
                impact_units=None,
                curve_type="indicator/piecewise_linear",
                points_x=points_x,
                points_y=[
                    float(row[key]) for key in row.keys() if key.startswith("dmg_")
                ],
                cap_of_points_x=None,
                cap_of_points_y=None,
                activation_of_points_x=None,
            ),
            axis=1,
        ).values
    )
    output_path = pathlib.Path(working_dir, attribute + ".csv")
    config_items_to_csv(config_items, str(output_path))
