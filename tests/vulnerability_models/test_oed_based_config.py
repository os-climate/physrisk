from enum import Enum
import importlib.resources
from io import StringIO
from typing import Optional, Protocol, runtime_checkable

import numpy as np
import pandas as pd
import pytest

from physrisk.kernel.assets import OEDAsset
from physrisk.kernel.hazards import RiverineInundation, Wind
import physrisk.data.static.vulnerability.oed_hazus
from physrisk.vulnerability_models.config_based_impact_curves import (
    PiecewiseLinearImpactCurve,
)
from physrisk.vulnerability_models.configuration.oed_mapping import (
    DamageType,
    HazusOccDescription,
    HazusOccToDamageFn,
    HazusOccToSBT,
    OEDHazusMapper,
    OEDOccToHazusOcc,
)
from physrisk.vulnerability_models.vulnerability import VulnerabilityModelsFactory


oed_occ_to_hazus_occ = """
oed_occupancy_code,oed_occupancy_name,hazus_occupancy_codes,hazus_occupancy_code_weights
1000,Unknown,"COM1,COM10,COM2,COM3,COM4,COM5,COM6,COM7,COM8,COM9,EPP,ESS,IND1,IND2,IND3,IND4,IND5,IND6,NGC,ORF,PSTGC,PWE,PWT1,PWT2,RES1,RES2,RES3A,RES3B,RES3C,RES3D,RES3E,RES3F,RES4,RES5,RES6,WWT",
1050,"Residential, General residential","RES1,RES2,RES3A,RES3B,RES3C,RES3D,RES3E,RES3F,RES4,RES5,RES6",
1051,"Residential, Permanent dwelling: single-family",RES1,
1052,"Residential, Permanent dwelling: multi-family","RES3A,RES3B,RES3C,RES3D,RES3E,RES3F",
1053,"Residential, Temporary lodging",RES4,
1054,"Residential, Group institutional housing",RES5,
1055,"Residential, Apartment/Condo","RES3A,RES3B,RES3C,RES3D,RES3E,RES3F",
1056,"Residential, Mid-Terraced Housing","RES3A,RES3B,RES3C,RES3D,RES3E,RES3F",
1057,"Residential, Renter","RES3A,RES3B,RES3C,RES3D,RES3E,RES3F",
1058,"Residential Apartment/Condo Asso, Common Areas","RES3A,RES3B,RES3C,RES3D,RES3E,RES3F",
1070,"Residential, detached house",RES1,
1071,"Residential, semi-detached house",RES1,
1115,"Commerical,Hotel - Small & Medium", RES4/2,
1253,"Transportation,Sea and inland waterways","COM4/2,COM4/3",
1300,"Utilities,Eletrical","EPP,ESS",
"""
# EPP,ESS #no numbers behind these codes, get_impact_curve couldnt extract the function

hazus_occ_to_damage_fn = """
hazus_occupancy_code,number_of_storeys_min,number_of_storeys_max,basement,damage_type,damage_fn_id
RES1,1,1,0,"structure,contents,inventory","129,45,"
RES1,1,1,1,"structure,contents,inventory","704,535,"
RES1,1,999,0,"structure,contents,inventory","111,27,"
RES1,1,999,1,"structure,contents,inventory","112,28,"
RES1,2,2,0,"structure,contents,inventory","107,23,"
RES1,2,2,1,"structure,contents,inventory","108,24,"
RES1,3,3,0,"structure,contents,inventory","109,25,"
RES1,3,3,1,"structure,contents,inventory","110,26,"
RES4/2,1,999,0,"structure,contents,inventory","211,87,"
RES4/2,1,999,1,"structure,contents,inventory","211,87,"
COM4/2,1,999,0,"structure,contents,inventory","433,283,"
COM4/2,1,999,1,"structure,contents,inventory","433,283,"
COM4/3,1,999,0,"structure,contents,inventory","434,284,"
COM4/3,1,999,1,"structure,contents,inventory","434,284,"
EPP,1,999,0,"structure,contents,inventory","util_61,util_61,util_61"
EPP,1,999,1,"structure,contents,inventory","util_61,util_61,util_61"
ESS,1,999,0,"structure,contents,inventory","util_64,util_64,util_64"
ESS,1,999,1,"structure,contents,inventory","util_64,util_64,util_64"
"""

occ_to_sbt = """
hazus_occupancy_code,number_of_storeys_min,number_of_storeys_max,sbt_codes,construction_code_range
REL1,1,1,"CECBL,MERBL,MHPHUD,SECBL,WMUH1","131-140,111-121,191-194,151-160,101-108"
REL1,2,999,WMUH2,101-108
RES1,1,1,"CERBL,MHPHUD,MSF1,SERBL,SPMBS,WSF1","131-140,191-194,111-121,151-160,151-160,101-108"
RES1,2,999,"MSF2,WSF2","111-121,101-108"
"""

hazus_occ_desc = """
hazus_occupancy_code,source,description
REL1,USACE - Galveston,Church
RES1,FIA,"Residential, all floors"
RES2,FIA,Mobile home
RES3,USACE - Chicago,Apartment Unit Grade
RES3A,BCAR - Jan 2011,"1to2 Stories, slab - no basement, Coastal A or V Zone"
RES3B,BCAR - Jan 2011,"1to2 Stories, slab - no basement, Coastal A or V Zone"
RES4,USACE - Galveston,Average Hotel & Motel
RES4/1,USACE - Galveston,Average Hotel & Motel
RES4/2,USACE - Galveston,Motel Unit
RES5,USACE - Galveston,Average institutional dormitory
RES6,USACE - Galveston,Nursing Home
"""


def test_fema_hazus_mappings():
    # source_dir = vulnerability_onboarding_dir()
    # config_builder = ConfigBuilderHazusFlood(
    #    source_dir=source_dir, adjust_to_absolute_depth=False
    # )
    # config_items = config_builder.build_config()
    config_items = VulnerabilityModelsFactory.embedded_vulnerability_config()

    df = pd.read_csv(StringIO(oed_occ_to_hazus_occ))
    oed_occ_to_hazus_occ_items = list(
        df.apply(lambda row: OEDOccToHazusOcc(**row), axis=1)
    )

    df = pd.read_csv(StringIO(hazus_occ_to_damage_fn))
    hazus_occ_to_damage_fn_items = list(
        df.apply(lambda row: HazusOccToDamageFn(**row), axis=1)
    )

    df = pd.read_csv(StringIO(occ_to_sbt))
    hazus_occ_to_sbt_items = list(df.apply(lambda row: HazusOccToSBT(**row), axis=1))

    df = pd.read_csv(StringIO(hazus_occ_desc))
    hazus_occ_desc_items = list(
        df.apply(lambda row: HazusOccDescription(**row), axis=1)
    )

    # config = [
    #     VulnerabilityConfigItem(
    #         hazard_class="CoastalInundation,PluvialInundation,RiverineInundation",
    #         asset_class="Asset",
    #         asset_identifier="hazus_fl_structure_dmg_id=112",
    #         indicator_id="flood_depth",
    #         indicator_units="metres",
    #         impact_id="damage",
    #         impact_units=None,
    #         curve_type="indicator/piecewise_linear",
    #         points_x=[0.05, 0.5, 1, 1.5, 2, 3, 4, 5, 6],
    #         points_y=[0, 0.667, 0.89, 0.947, 1, 1, 1, 1, 1],
    #         activation_of_points_x=None,
    #         cap_of_points_x=None,
    #         cap_of_points_y=None,
    #     )
    # ]
    mapper = OEDHazusMapper(
        oed_occ_to_hazus_occ=oed_occ_to_hazus_occ_items,
        hazus_occ_to_damage_fn=hazus_occ_to_damage_fn_items,
        hazus_occ_to_sbt=hazus_occ_to_sbt_items,
        hazus_occ_description=hazus_occ_desc_items,
        vulnerability_config_items=config_items,
    )
    # test = AgricultureAsset(
    #     oed_occupancy_code=1071,
    #     latitude=51.5074,
    #     longitude=-0.1278,
    #     location="",
    #     type="",
    #     number_of_storeys=1,
    #     basement=0,
    # )

    asset1 = OEDAsset(
        occupancy_code=1071,
        latitude=51.5074,
        longitude=-0.1278,
        number_of_storeys=9,
        basement=0,
        construction_code=191,
    )
    impact_curve, explanation = mapper.map(asset1, RiverineInundation, explain=True)
    expected_y = np.array(
        [
            0.0,
            0.0,
            0.03,
            0.09,
            0.13,
            0.25,
            0.27,
            0.28,
            0.33,
            0.34,
            0.41,
            0.43,
            0.45,
            0.46,
            0.47,
            0.48,
            0.49,
            0.5,
            0.51,
            0.52,
            0.53,
            0.54,
            0.55,
            0.56,
            0.57,
            0.58,
            0.59,
        ]
    )
    assert isinstance(impact_curve, PiecewiseLinearImpactCurve)
    np.testing.assert_allclose(impact_curve.points_y, expected_y)
    asset2 = OEDAsset(
        occupancy_code=1071,
        latitude=51.5074,
        longitude=-0.1278,
        number_of_storeys=1,
        basement=0,
    )
    config_item, explanation = mapper.map(asset2, RiverineInundation, explain=True)
    assert (
        explanation.resolved_curves[0].resolved_ids[DamageType.STRUCTURE][0]
        == "hazus_fl_structure_dmg_id=129"  # this could mapped to 111 too right? it didnt extract two curves
    )
    asset3 = OEDAsset(
        occupancy_code=1070,
        latitude=51.5074,
        longitude=-0.1278,
        number_of_storeys=3,
        basement=1,
    )
    config_item, explanation = mapper.map(asset3, RiverineInundation, explain=True)
    assert (
        explanation.resolved_curves[0].resolved_ids[DamageType.STRUCTURE][0]
        == "hazus_fl_structure_dmg_id=110"
    )
    config_item, explanation = mapper.map(asset3, Wind, explain=True)
    assert (
        explanation.resolved_curves[0].resolved_ids[DamageType.STRUCTURE][0]
        == "hazus_wind_spec_build_type=WSF2,damage_type=structure"
    )

    asset4 = OEDAsset(
        occupancy_code=1071,
        latitude=0,
        longitude=0,
        number_of_storeys=1,
        basement=0,
        construction_code=191,
    )
    with pytest.raises(Exception):
        mapper.map(asset4, PluvialInundation, explain=True)  # import PluvialInundation

    asset5 = OEDAsset(
        occupancy_code=1071,
        latitude=0,
        longitude=0,
        number_of_storeys=1,
        basement=3,  # invalid basement input, ValueError; 0 = unknown / default, 1 = unfinished, 2 = 100% finished
        construction_code=191,
    )
    with pytest.raises(ValueError, match="basement"):
        mapper.map(asset5, RiverineInundation, explain=True)

    asset6 = OEDAsset(
        occupancy_code=1071,
        latitude=0,
        longitude=0,
        number_of_storeys=-10,  # 1000/-10: invalid number_of_storeys, no dmg curve output; # -1 = unknown No. storeys - low rise, -2 = unknown No. storeys - mid rise, -3 = Unknown no. storeys = high rise; 1.5 will return extract from [1,999];
        basement=1,
        construction_code=191,
    )
    config_item, explanation = mapper.map(asset6, RiverineInundation, explain=True)
    assert explanation.resolved_curves == []

    # asset7 = OEDAsset(
    #     occupancy_code=1070,
    #     latitude=0,
    #     longitude=0,
    #     number_of_storeys= 2,
    #     basement=1,
    #     #construction_code=191                  # missing construction code
    #     )
    # config_item, explanation = mapper.map(asset7, RiverineInundation, explain=True)
    # assert explanation is not None
    # assert len(explanation.resolved_curves) >= 1

    # asset8 = OEDAsset(
    #     occupancy_code=1253,
    #     latitude=0,
    #     longitude=0,
    #     number_of_storeys= 2,
    #     basement=1,
    #     #construction_code=191
    #     )
    # config_item, explanation = mapper.map(asset8, RiverineInundation, explain=True)
    # assert (
    #     explanation.resolved_curves[0].resolved_ids[DamageType.STRUCTURE][0]
    #     == "hazus_fl_structure_dmg_id=433"
    # )
    # assert (
    #     len(explanation.resolved_curves)==2
    # )

    # asset9 = OEDAsset(
    #     occupancy_code=1300,
    #     latitude=0,
    #     longitude=0,
    #     number_of_storeys= 2,
    #     basement=1,
    #     #construction_code=191
    #     )
    # config_item, explanation = mapper.map(asset9, RiverineInundation, explain=True)
    # assert (
    #     explanation.resolved_curves[0].resolved_ids[DamageType.STRUCTURE][0]
    #     == "hazus_fl_structure_dmg_id=util_61"
    # )


@runtime_checkable
class OEDProperties(Protocol):  # basement: int?
    oed_occupancy_code: int
    number_of_storeys: Optional[int]
    construction_code: Optional[int]
    first_floor_elevation: Optional[float]


class IDType(str, Enum):
    # the flood IDs are the Hazus numerical IDs
    HAZUS_FLOOD_structure_ID = "hazus_flood_structure_id"
    HAZUS_FLOOD_contentsS_ID = "hazus_flood_contents_id"

    # the wind IDs are Hazus 'specific building types' or SBTs
    HAZUS_WIND_structure_ID = "hazus_wind_structure_id"
    HAZUS_WIND_contentsS_ID = "hazus_wind_contents_id"


def test_multi_interval_tree():
    index = pd.IntervalIndex.from_arrays([0.1, 1, 1.5], [0.3, 2, 2.5])
    i = index.get_loc(0.2)
    assert i == 0
    i = index.get_loc(1.7)
    assert i == slice(1, 3, None)


@pytest.mark.skip("Just a small example in case needed later")
def test_pack_unpack_config():
    csv_dir = importlib.resources.files(physrisk.data.static.vulnerability.oed_hazus)
    with pd.ExcelWriter(csv_dir / "config.xlsx", engine="openpyxl") as writer:
        for csv_file in csv_dir.glob("*.csv"):
            df = pd.read_csv(csv_file)
            sheet_name = csv_file.name.replace(".csv", "")
            df.to_excel(writer, sheet_name=sheet_name, index=False)

    sheets = pd.read_excel(csv_dir / "config.xlsx", sheet_name=None)
    for sheet_name, df in sheets.items():
        csv_path = csv_dir / f"{sheet_name}2.csv"
        df.to_csv(csv_path, index=False)
